#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check file sizes
.husky/check-file-size.sh || exit 1

# Run type check
echo "üîç Running TypeScript type check..."
npm run typecheck || exit 1

# Run linter
echo "üé® Running ESLint..."
npm run lint || exit 1

# Run staged files linting
echo "‚ú® Running lint-staged..."
npx lint-staged || exit 1

# Run tests
echo "üß™ Running tests..."
TEST_OUTPUT=$(npm test 2>&1)
TEST_EXIT=$?

# Check for skipped tests in the summary line (e.g., "Tests  391 passed | 12 skipped")
if echo "$TEST_OUTPUT" | grep -E "^\s+Tests\s+" | grep -qE "[0-9]+ skipped"; then
  echo "‚ùå Error: Skipped tests detected!"
  echo "$TEST_OUTPUT" | grep -E "^\s+(Test Files|Tests)\s+"
  exit 1
fi

# Check if tests failed
if [ $TEST_EXIT -ne 0 ]; then
  echo "‚ùå Tests failed!"
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
