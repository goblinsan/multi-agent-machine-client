templates:
  context_analysis:
    type: PersonaRequestStep
    outputs: [context_request_result, context_request_status]
    config:
      step: "1-context"
      persona: context
      intent: context_analysis
      payload:
        task: ${task}
        repo: ${repo_remote}
        repo_root: ${repo_root}
        project_id: ${projectId}
        project_slug: ${projectSlug}
        project_name: ${projectName}
        milestone: ${milestone}
        milestone_name: ${milestone_name}
        repoScan: ${repoScan}
        context_metadata: ${context.metadata}

  implementation:
    type: PersonaRequestStep
    outputs: [implementation_request_result, implementation_request_status]
    config:
      step: "2-implementation"
      persona: lead-engineer
      intent: implementation
      payload:
        task: ${task}
        plan_artifact: .ma/tasks/${task.id}/03-plan-final.md
        repo: ${repo_remote}
        repo_root: ${repo_root}
        project_id: ${projectId}
        project_slug: ${projectSlug}
        project_name: ${projectName}

  qa_review:
    type: PersonaRequestStep
    outputs: [qa_request_result, qa_request_status]
    config:
      step: "3-qa"
      persona: tester-qa
      intent: qa
      payload:
        task: ${task}
        plan_artifact: .ma/tasks/${task.id}/03-plan-final.md
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        repo: ${repo_remote}
        repo_root: ${repo_root}
        project_id: ${projectId}
        project_slug: ${projectSlug}
        project_name: ${projectName}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}

  code_review:
    type: PersonaRequestStep
    outputs: [code_review_request_result, code_review_request_status]
    config:
      step: "4-code-review"
      persona: code-reviewer
      intent: code_review
      payload:
        task: ${task}
        plan_artifact: .ma/tasks/${task.id}/03-plan-final.md
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        repo: ${repo_remote}
        branch: ${featureBranchName}
        repo_root: ${repo_root}
        project_id: ${projectId}
        project_slug: ${projectSlug}
        project_name: ${projectName}
        resume_review: ${resume_review}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}

  security_review:
    type: PersonaRequestStep
    outputs: [security_request_result, security_request_status]
    config:
      step: "5-security"
      persona: security-review
      intent: security_review
      payload:
        task: ${task}
        plan_artifact: .ma/tasks/${task.id}/03-plan-final.md
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        code_review_result: ${code_review_request_result}
        repo: ${repo_remote}
        branch: ${featureBranchName}
        repo_root: ${repo_root}
        project_id: ${projectId}
        project_slug: ${projectSlug}
        project_name: ${projectName}
        resume_review: ${resume_review}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}

  devops_review:
    type: PersonaRequestStep
    outputs: [devops_request_result, devops_request_status]
    config:
      step: "6-devops"
      persona: devops
      intent: devops_review
      payload:
        task: ${task}
        plan_artifact: .ma/tasks/${task.id}/03-plan-final.md
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        code_review_result: ${code_review_request_result}
        security_result: ${security_request_result}
        repo: ${repo_remote}
        branch: ${featureBranchName}
        repo_root: ${repo_root}
        project_id: ${projectId}
        project_slug: ${projectSlug}
        project_name: ${projectName}
        resume_review: ${resume_review}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}
