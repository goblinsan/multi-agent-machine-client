templates:
  context_analysis:
    type: PersonaRequestStep
    outputs: [context_request_result, context_request_status]
    config:
      step: "1-context"
      persona: context
      intent: context_analysis
      prompt_template: "prompts/context-analysis.txt"
      payload:
        task: ${task}
        repo: ${repo_remote}
        repo_root: ${repo_root}
        project_id: ${projectId}
        repo_slug: ${repoSlug}
        project_name: ${projectName}
        milestone: ${milestone}
        milestone_name: ${milestone_name}
        context_metadata: ${context.metadata}
        context_snapshot_json: ${context_snapshot_json}
        context_files_ndjson: ${context_files_ndjson}
        context_summary_md: "${context_summary_md || ''}"
        context_snapshot_path: "${context_snapshot_path || ''}"
        context_summary_path: "${context_summary_path || ''}"
        context_files_ndjson_path: "${context_files_ndjson_path || ''}"

  implementation:
    type: PersonaRequestStep
    outputs: [implementation_request_result, implementation_request_status]
    config:
      step: "2-implementation"
      persona: lead-engineer
      intent: implementation
      prompt_template: "prompts/lead-engineer-implementation.txt"
      payload:
        task: ${task}
        plan_artifact: .ma/tasks/${task.id}/03-plan-final.md
        plan_required_files: "${plan_required_files || []}"
        missing_plan_files_pre_implementation: "${record_plan_key_files.missing_files || []}"
        implementation_guard_missing_files: "${implementation_guard_missing_files || []}"
        implementation_guard_missing_summary: "${implementation_guard_missing_summary || ''}"
        implementation_config_validation_summary: "${implementation_config_validation_summary || ''}"
        implementation_config_validation_errors: "${implementation_config_validation_errors || []}"
        implementation_retry_attempt: "${implementation_retry_attempt || 1}"
        implementation_retry_max_attempts: "${implementation_retry_max_attempts || 1}"
        context_primary_language: ${context_primary_language}
        context_allowed_languages: ${context_allowed_languages}
        context_snapshot_json: "${context_snapshot_json || ''}"
        context_files_ndjson: "${context_files_ndjson || ''}"
        context_summary_md: "${context_summary_md || ''}"
        context_snapshot_path: "${context_snapshot_path || ''}"
        context_files_ndjson_path: "${context_files_ndjson_path || ''}"
        repo: ${repo_remote}
        repo_root: ${repo_root}
        project_id: ${projectId}
        repo_slug: ${repoSlug}
        project_name: ${projectName}

  qa_review:
    type: PersonaRequestStep
    outputs: [qa_request_result, qa_request_status]
    config:
      step: "3-qa"
      persona: tester-qa
      intent: qa
      abortOnFailure: false
      payload:
        task: ${task}
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        plan_required_files: "${plan_required_files || []}"
        detected_test_command: ${detected_test_command}
        repo: ${repo_remote}
        repo_root: ${repo_root}
        project_id: ${projectId}
        repo_slug: ${repoSlug}
        project_name: ${projectName}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}
        applied_files: ${last_applied_files}
        repo_diff_patch: ${review_diff_patch}
        repo_diff_summary: ${review_diff_summary}
        repo_changed_files: ${review_diff_files}
        context_snapshot_json: "${context_snapshot_json || ''}"
        context_files_ndjson: "${context_files_ndjson || ''}"
        context_summary_md: "${context_summary_md || ''}"
        context_snapshot_path: "${context_snapshot_path || ''}"
        context_files_ndjson_path: "${context_files_ndjson_path || ''}"

  code_review:
    type: PersonaRequestStep
    outputs: [code_review_request_result, code_review_request_status]
    config:
      step: "4-code-review"
      persona: code-reviewer
      intent: code_review
      abortOnFailure: false
      payload:
        task: ${task}
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        repo: ${repo_remote}
        branch: ${featureBranchName}
        repo_root: ${repo_root}
        project_id: ${projectId}
        repo_slug: ${repoSlug}
        project_name: ${projectName}
        resume_review: ${resume_review}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}
        context_summary: ${context_summary_md}
        context_insights: ${context_insights}
        context_primary_language: ${context_primary_language}
        context_secondary_languages: ${context_secondary_languages}
        context_frameworks: ${context_frameworks}
        context_potential_issues: ${context_potential_issues}
        allowed_languages: ${context_allowed_languages}
        allowed_languages_normalized: ${context_allowed_languages_normalized}
        applied_files: ${last_applied_files}
        repo_diff_patch: ${review_diff_patch}
        repo_diff_summary: ${review_diff_summary}
        repo_changed_files: ${review_diff_files}
        context_snapshot_json: "${context_snapshot_json || ''}"
        context_files_ndjson: "${context_files_ndjson || ''}"
        context_summary_md: "${context_summary_md || ''}"
        context_snapshot_path: "${context_snapshot_path || ''}"
        context_files_ndjson_path: "${context_files_ndjson_path || ''}"

  security_review:
    type: PersonaRequestStep
    outputs: [security_request_result, security_request_status]
    config:
      step: "5-security"
      persona: security-review
      intent: security_review
      abortOnFailure: false
      payload:
        task: ${task}
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        code_review_result: ${code_review_request_result}
        repo: ${repo_remote}
        branch: ${featureBranchName}
        repo_root: ${repo_root}
        project_id: ${projectId}
        repo_slug: ${repoSlug}
        project_name: ${projectName}
        resume_review: ${resume_review}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}
        repo_diff_patch: ${review_diff_patch}
        repo_diff_summary: ${review_diff_summary}
        repo_changed_files: ${review_diff_files}
        context_snapshot_json: "${context_snapshot_json || ''}"
        context_files_ndjson: "${context_files_ndjson || ''}"
        context_summary_md: "${context_summary_md || ''}"
        context_snapshot_path: "${context_snapshot_path || ''}"
        context_files_ndjson_path: "${context_files_ndjson_path || ''}"

  devops_review:
    type: PersonaRequestStep
    outputs: [devops_request_result, devops_request_status]
    config:
      step: "6-devops"
      persona: devops
      intent: devops_review
      abortOnFailure: false
      payload:
        task: ${task}
        implementation: ${implementation_request_result}
        qa_result: ${qa_request_result}
        code_review_result: ${code_review_request_result}
        security_result: ${security_request_result}
        repo: ${repo_remote}
        branch: ${featureBranchName}
        repo_root: ${repo_root}
        project_id: ${projectId}
        repo_slug: ${repoSlug}
        project_name: ${projectName}
        resume_review: ${resume_review}
        tdd_aware: ${tdd_aware}
        tdd_stage: ${tdd_stage}
        repo_diff_patch: ${review_diff_patch}
        repo_diff_summary: ${review_diff_summary}
        repo_changed_files: ${review_diff_files}
        context_snapshot_json: "${context_snapshot_json || ''}"
        context_files_ndjson: "${context_files_ndjson || ''}"
        context_summary_md: "${context_summary_md || ''}"
        context_snapshot_path: "${context_snapshot_path || ''}"
        context_files_ndjson_path: "${context_files_ndjson_path || ''}"
