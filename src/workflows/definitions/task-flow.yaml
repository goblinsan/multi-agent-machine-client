name: "task-flow"
description: "Consolidated task processing workflow with unified review feedback loops and TDD awareness"
version: "3.0.0"
trigger:
  condition: "task_type == 'task' || task_type == 'feature'"
context:
  repo_required: true
  branch_strategy: "feature-branch"

steps:
  - name: checkout_branch
    type: GitOperationStep
    description: "Checkout feature branch from base branch using milestone slug from dashboard"
    config:
      operation: "checkoutBranchFromBase"
      baseBranch: "main"
      newBranch: "${featureBranchName}"

  - name: mark_task_in_progress
    type: SimpleTaskStatusStep
    description: "Mark task as in progress on dashboard"
    depends_on: ["checkout_branch"]
    config:
      status: "in_progress"

  - name: context_scan
    type: ContextStep
    description: "Scan repository structure and create context snapshot"
    depends_on: ["mark_task_in_progress"]
    config:
      repoPath: "${repo_root}"
      includePatterns: ["**/*"]
      excludePatterns: ["node_modules/**", ".git/**", "dist/**", "build/**", ".ma/**"]
      maxFiles: 1000
      maxBytes: 10485760
      maxDepth: 10
      trackLines: true
      trackHash: false
      forceRescan: false

  - template: context_analysis
    name: context_request
    depends_on: ["context_scan"]
    condition: ${context_scan.reused_existing} == false

  - name: planning_loop
    type: PlanningLoopStep
    description: "Plan creation and evaluation loop with max 5 iterations"
    depends_on: ["context_scan"]
    config:
      maxIterations: 5
      plannerPersona: "implementation-planner"
      evaluatorPersona: "plan-evaluator" 
      planStep: "2-plan"
      evaluateStep: "2.5-evaluate-plan"
      payload:
        task: ${task}
        context: "${context_request_result}"
        repo: "${repo_remote}"
        project_id: "${projectId}"

  - template: implementation
    name: implementation_request
    depends_on: ["planning_loop"]

  - name: apply_implementation_edits
    type: DiffApplyStep
    description: "Parse, apply, commit, and push implementation edits from lead engineer"
    depends_on: ["implementation_request"]
    config:
      source_output: "implementation_request"
      validation: "syntax_check"
      commit_message: "feat: implement ${taskName}"

  - name: verify_diff
    type: GitOperationStep
    description: "Verify remote branch has diff from base"
    depends_on: ["apply_implementation_edits"]
    config:
      operation: "verifyRemoteBranchHasDiff"

  - name: ensure_branch_published
    type: GitOperationStep
    description: "Ensure branch is published to remote before code reviews"
    depends_on: ["verify_diff"]
    config:
      operation: "ensureBranchPublished"

  - template: qa_review
    name: qa_request
    depends_on: ["ensure_branch_published"]

  - name: commit_qa_result
    type: GitArtifactStep
    description: "Commit QA review result to .ma/tasks/{id}/reviews/qa.json"
    depends_on: ["qa_request"]
    config:
      source_output: "qa_request_result"
      artifact_path: ".ma/tasks/${task.id}/reviews/qa.json"
      commit_message: "test(ma): QA review for task ${task.id}"
      format: "json"

  - name: handle_qa_failure
    type: SubWorkflowStep
    description: "PM prioritization and bulk task creation for QA failures (unified pattern)"
    depends_on: ["qa_request"]
    condition: "${qa_request_status} == 'fail' || ${qa_request_status} == 'unknown'"
    config:
      workflow: "review-failure-handling"
      inputs:
        review_type: "qa"
        review_result: "${qa_request_result}"
        review_status: "${qa_request_status}"
        milestone_context: "${milestone}"
        task: ${task}
        parent_task_id: "${taskId}"
        priority_scores:
          urgent: 1200
          deferred: 50
        config:
          block_original_task: true
        project_id: "${projectId}"
        repo: "${repo_remote}"
        tdd_aware: "${tdd_aware || false}"
        tdd_stage: "${tdd_stage || 'implementation'}"
        existing_tasks: []

  - name: mark_task_in_review
    type: SimpleTaskStatusStep
    description: "Mark task as in review on dashboard when QA passes"
    depends_on: ["qa_request"]
    condition: "${qa_request_status} == 'pass'"
    config:
      status: "in_review"

  - template: code_review
    name: code_review_request
    depends_on: ["mark_task_in_review"]

  - name: commit_code_review_result
    type: GitArtifactStep
    description: "Commit code review result to .ma/tasks/{id}/reviews/code-review.json"
    depends_on: ["code_review_request"]
    config:
      source_output: "code_review_request_result"
      artifact_path: ".ma/tasks/${task.id}/reviews/code-review.json"
      commit_message: "refactor(ma): code review for task ${task.id}"
      format: "json"

  - name: handle_code_review_failure
    type: SubWorkflowStep
    description: "PM prioritization and bulk task creation for code review failures"
    depends_on: ["code_review_request"]
    condition: "${code_review_request_status} == 'fail' || ${code_review_request_status} == 'unknown'"
    config:
      workflow: "review-failure-handling"
      inputs:
        review_type: "code_review"
        review_result: "${code_review_request_result}"
        review_status: "${code_review_request_status}"
        milestone_context: "${milestone}"
        task: ${task}
        parent_task_id: "${taskId}"
        priority_scores:
          urgent: 1000
          deferred: 50
        config:
          block_original_task: true
        project_id: "${projectId}"
        repo: "${repo_remote}"
        tdd_aware: "${tdd_aware || false}"
        tdd_stage: "${tdd_stage || 'implementation'}"
        existing_tasks: []

  - template: security_review
    name: security_request
    depends_on: ["code_review_request"]
    condition: "${code_review_request_status} == 'pass'"

  - name: commit_security_result
    type: GitArtifactStep
    description: "Commit security review result to .ma/tasks/{id}/reviews/security.json"
    depends_on: ["security_request"]
    config:
      source_output: "security_request_result"
      artifact_path: ".ma/tasks/${task.id}/reviews/security.json"
      commit_message: "security(ma): security review for task ${task.id}"
      format: "json"

  - name: handle_security_failure
    type: SubWorkflowStep
    description: "PM prioritization and bulk task creation for security failures"
    depends_on: ["security_request"]
    condition: "${security_request_status} == 'fail' || ${security_request_status} == 'unknown'"
    config:
      workflow: "review-failure-handling"
      inputs:
        review_type: "security_review"
        review_result: "${security_request_result}"
        review_status: "${security_request_status}"
        milestone_context: "${milestone}"
        task: ${task}
        parent_task_id: "${taskId}"
        priority_scores:
          urgent: 1500
          deferred: 50
        config:
          block_original_task: true
        project_id: "${projectId}"
        repo: "${repo_remote}"
        tdd_aware: "${tdd_aware || false}"
        tdd_stage: "${tdd_stage || 'implementation'}"
        existing_tasks: []

  - template: devops_review
    name: devops_request
    depends_on: ["security_request"]
    condition: "${security_request_status} == 'pass'"

  - name: commit_devops_result
    type: GitArtifactStep
    description: "Commit DevOps review result to .ma/tasks/{id}/reviews/devops.json"
    depends_on: ["devops_request"]
    config:
      source_output: "devops_request_result"
      artifact_path: ".ma/tasks/${task.id}/reviews/devops.json"
      commit_message: "ci(ma): DevOps review for task ${task.id}"
      format: "json"

  - name: handle_devops_failure
    type: SubWorkflowStep
    description: "PM prioritization and bulk task creation for DevOps failures"
    depends_on: ["devops_request"]
    condition: "${devops_request_status} == 'fail' || ${devops_request_status} == 'unknown'"
    config:
      workflow: "review-failure-handling"
      inputs:
        review_type: "devops_review"
        review_result: "${devops_request_result}"
        review_status: "${devops_request_status}"
        milestone_context: "${milestone}"
        task: ${task}
        parent_task_id: "${taskId}"
        priority_scores:
          urgent: 1100
          deferred: 50
        config:
          block_original_task: true
        project_id: "${projectId}"
        repo: "${repo_remote}"
        tdd_aware: "${tdd_aware || false}"
        tdd_stage: "${tdd_stage || 'implementation'}"
        existing_tasks: []

  - name: mark_task_done
    type: SimpleTaskStatusStep
    description: "Mark task as completed on dashboard when all reviews pass"
    depends_on: ["devops_request"]
    condition: "${devops_request_status} == 'pass'"
    config:
      task_id: "${taskId}"
      project_id: "${projectId}"
      status: "done"

  - name: check_milestone_completion
    type: MilestoneStatusCheckStep
    description: "Check if milestone has remaining incomplete tasks"
    depends_on: ["mark_task_done"]
    config:
      check_type: "incomplete_tasks"
      include_cancelled: false

  - name: pm_evaluate_suggestions
    type: PersonaRequestStep
    description: "Send suggested tasks to PM for urgency evaluation"
    depends_on: ["check_milestone_completion"]
    condition: "${milestone_has_remaining_tasks} == true"
    config:
      step: "6-pm-evaluate-suggestions"
      persona: "project-manager"
      intent: "evaluate_task_urgency"
      payload:
        milestone: "${milestone}"
        completed_task: ${task}
        remaining_tasks: "${check_milestone_completion_remaining_tasks}"
        suggested_tasks: "${qa_iteration_loop_suggested_tasks}"
        milestone_completion_percentage: "${milestone_completion_percentage}"
        repo: "${repo_remote}"
        project_id: "${projectId}"

failure_handling:
  on_workflow_failure:
    - name: mark_task_blocked
      type: SimpleTaskStatusStep
      description: "Mark task as blocked when workflow fails"
      config:
        status: "blocked"

timeouts:
  context_request_timeout: 600000
  default_step: 300000
